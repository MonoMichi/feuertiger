# Migration `20201126194934-4718ce4`

This migration has been generated by michael.thanei at 11/26/2020, 7:49:34 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."UserRole" AS ENUM ('USER', 'ADMIN')

CREATE TYPE "public"."DepartmentUserRole" AS ENUM ('GUEST', 'ADMIN')

ALTER TABLE "Membership" DROP CONSTRAINT "Membership_personId_fkey"

CREATE TABLE "Department" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "DepartmentMembership" (
    "id" TEXT NOT NULL,
    "active" BOOLEAN NOT NULL,
    "entryDate" TIMESTAMP(3) NOT NULL,
    "departureDate" TIMESTAMP(3),
    "userRoles" "DepartmentUserRole"[],
    "personId" TEXT NOT NULL,
    "userId" TEXT,
    "departmentId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "User" (
    "id" TEXT NOT NULL,
    "uid" TEXT NOT NULL,
    "firstname" TEXT NOT NULL,
    "lastname" TEXT NOT NULL,
    "personId" TEXT,
    "userRoles" "UserRole"[],

    PRIMARY KEY ("id")
)

DROP TABLE "Membership"

ALTER TABLE "DepartmentMembership" ADD FOREIGN KEY("personId")REFERENCES "Person"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "DepartmentMembership" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "DepartmentMembership" ADD FOREIGN KEY("departmentId")REFERENCES "Department"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "User" ADD FOREIGN KEY("personId")REFERENCES "Person"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201110210036-05bd506..20201126194934-4718ce4
--- datamodel.dml
+++ datamodel.dml
@@ -1,14 +1,13 @@
 datasource postgresql {
-  url = "***"
+  url = "***"
   provider = "postgresql"
 }
 generator client {
-  provider        = "prisma-client-js"
-  previewFeatures = ["transactionApi"]
-  binaryTargets   = ["native", "linux-musl"]
-  output          = "../dist"
+  provider      = "prisma-client-js"
+  binaryTargets = ["native", "linux-musl"]
+  output        = "../dist"
 }
 model Exercise {
   id           String   @id
@@ -28,17 +27,8 @@
   country      String
   Person       Person[]
 }
-model Membership {
-  id            String    @id
-  active        Boolean
-  entryDate     DateTime
-  personId      String
-  person        Person    @relation("Person_Membership", fields: [personId])
-  departureDate DateTime?
-}
-
 enum Grade {
   FA
   FM
   OFM
@@ -65,9 +55,9 @@
   grade           Grade
 }
 model Person {
-  id                    String       @id
+  id                    String                 @id
   firstname             String
   lastname              String
   sex                   Sex
   phone                 String
@@ -76,17 +66,59 @@
   avatar                String
   dateOfBirth           DateTime
   membershipNumber      String
   addressId             String
-  address               Address      @relation(fields: [addressId], references: [id])
-  memberships           Membership[] @relation("Person_Membership")
-  promotions            Promotion[]  @relation("Person_Promotion")
-  exercisesParticipated Exercise[]   @relation("Exercise_Participant", references: [id])
-  exercisesLeaded       Exercise[]   @relation("Exercise_Leader", references: [id])
+  address               Address                @relation(fields: [addressId], references: [id])
+  memberships           DepartmentMembership[] @relation("Person_DepartmentMembership")
+  promotions            Promotion[]            @relation("Person_Promotion")
+  exercisesParticipated Exercise[]             @relation("Exercise_Participant", references: [id])
+  exercisesLeaded       Exercise[]             @relation("Exercise_Leader", references: [id])
+  User                  User[]
 }
 model Timeslot {
   id       String     @id
   start    DateTime
   end      DateTime
   exercise Exercise[]
 }
+
+enum UserRole {
+  USER
+  ADMIN
+}
+
+enum DepartmentUserRole {
+  GUEST
+  ADMIN
+}
+
+model Department {
+  id          String                 @id
+  name        String
+  memberships DepartmentMembership[] @relation("Department_DepartmentMembership")
+}
+
+model DepartmentMembership {
+  id            String               @id
+  active        Boolean
+  entryDate     DateTime
+  departureDate DateTime?
+  userRoles     DepartmentUserRole[]
+  personId      String
+  person        Person               @relation("Person_DepartmentMembership", fields: [personId])
+  userId        String?
+  user          User?                @relation("User_DepartmentMembership", fields: [userId])
+  departmentId  String
+  department    Department           @relation("Department_DepartmentMembership", fields: [departmentId])
+}
+
+model User {
+  id                    String                 @id
+  uid                   String
+  firstname             String
+  lastname              String
+  personId              String?
+  person                Person?                @relation(fields: [personId], references: [id])
+  departmentMemberships DepartmentMembership[] @relation("User_DepartmentMembership")
+  userRoles             UserRole[]
+}
```


